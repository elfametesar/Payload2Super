#!/sbin/sh

OUTFD=/proc/self/fd/$2
ZIPFILE="$3"
TMPDIR=/data/local/tmp

if  [ -z "$(getprop sys.boot_completed)" ] && [ -z "$(getprop dev.bootcomplete)" ]; then
    export NOT_IN_RECOVERY=0
else
    export NOT_IN_RECOVERY=1
fi

outfd() {
  while read line; do
    if [ $NOT_IN_RECOVERY -eq 0 ]; then 
    	echo "ui_print $line" >> $OUTFD
    else 
    	echo "$line"
    fi
  done 
}

cleanup() {
	rm -rf META-INF flashable tmp tmp2 pay2sup.sh pay2sup_helper.sh erofs_to_ext4.sh
}

unzip "$ZIPFILE" -o -d $TMPDIR
cd $TMPDIR
$(which sh) pay2sup.sh --recovery | outfd
cleanup || true
if [ $NOT_IN_RECOVERY -eq 0 ]; then
	avbctl --force disable-verification
	avbctl --force disable-verity
fi
